---
date_created: 2024-06-03 17:05
author: 
date_published: 
url:
---
# 모듈 7 모니터링 및 크기 조정

# 모니터링

## 모니터링의 중요성

- **운영 상태 확인**
  - 오프라인 호스트 유무 확인
  - 모든 호스트의 정상 작동 여부 확인

- **애플리케이션 성능 모니터링**
  - 서버의 CPU 사용률 확인

- **리소스 활용 최적화**
  - 비용 최소화와 효율 극대화

- **보안 및 감사 로그**
  - 보안 감사에 활용

- **문제 해결**
  - 인스턴스 엑세스 로그나 백엔드 애플리케이션 로그 활용

## AWS 모니터링 도구

### CloudWatch Logs

- **기능**
  - 로그 스트림을 통해 파일 전송
  - CloudWatch 지표 생성
- **활용**
  - 경보 생성

### AWS CloudTrail

- **기능**
  - 사용자 활동 및 API 사용량 추적
  - S3 버킷 복제 기록
- **활용**
  - 모든 단일 작업 추적
  - 문제 해결과 보안 감사에 유용

### VPC 흐름 로그

- **기능**
  - 네트워크 인터페이스의 IP 트래픽 정보 캡처
- **활용**
  - ENI 및 사용자 정의 로그 정보 캡처
  - Amazon S3 또는 CloudWatch Logs 로그 스트림으로 데이터 전송
  - Athena를 통해 데이터 분석

### CloudWatch

- **기능**
  - EC2 인스턴스, S3 버킷, Lambda 함수 등의 활동 기록
  - 지표 생성 및 모니터링
- **활용**
  - 서비스에서 수집된 데이터 포인트 그래프화
  - 프로그래밍 방식으로 지표 쿼리 가능

### CloudWatch Logs

- **기능**
  - 로그 파일을 CloudWatch Logs로 전송
  - 지표 필터 지정으로 CloudWatch 지표 생성
- **활용**
  - 액세스 로그를 CloudWatch Logs에 저장
  - 지표를 통한 경보 및 이벤트 생성

## 예시

- **CloudTrail 기록 예시**
  - 요청한 사람: Alice
  - 요청 리소스: EC2 인스턴스, DynamoDB 테이블, Lambda 함수 등
  - 활동 발생 위치와 시간 기록

- **VPC 흐름 로그 정보**
  - 요청 시작 및 종료 시간
  - 패킷 수락 또는 삭제 여부
  - 로그 상태, 대상 포트, 프로토콜, 소스 및 대상 IP 주소
  - 인터페이스 아이디 기록

## 결론

- AWS 모니터링 도구는 운영 상태, 애플리케이션 성능, 리소스 활용, 보안 및 문제 해결에 필수적임
- CloudWatch, CloudTrail, VPC 흐름 로그 등을 통해 다양한 로그와 지표를 활용 가능
- 효과적인 모니터링을 통해 시스템의 안정성과 효율성을 유지할 수 있음

# 경보 및 이벤트

## CloudWatch 경보 및 이벤트

### 경보 설정 및 사용

- **경보 생성 방법**
  - CloudWatch 지표 식별 후 경보 생성
  - 로그 스트림 또는 PutMetricData API 호출에서 지표 가져오기

- **경보 상태**
  - **정상** OK: 지정한 임계 값을 초과하지 않음
  - **경보** ALARM: 지정한 임계 값을 초과
  - **데이터 부족** INSUFFICIENT_DATA: 데이터가 부족한 상태

### 예시: 온도 모니터링

- **온도 예시**
  - Python 스크립트로 매 분마다 CloudWatch에 실내 온도 전송
  - 지난 5분 동안 온도가 75도보다 높은 데이터 포인트가 10개 있으면 경보 발생

### CPU 사용률 경보 예시

- **CPU 사용률 경보 설정**
  - 5분 동안 두 번 연속으로 CPU 사용률이 25%를 초과하면 경보 상태
  - 예시 데이터 포인트: 75%, 23%, 49%, 50%, 7%, 20%
  - 두 개의 연속 기간 동안 평균 CPU 사용률이 25%를 초과하면 경보

### 경보 트리거 작업

- **Lambda 함수**
  - 경보가 발생하면 Lambda 함수를 트리거
- **자동 크기 조정**
  - 경보 발생 시 인스턴스 플릿의 수를 늘리거나 줄임

### Amazon EventBridge

- **기능**
  - 지점 간 통합 작성의 어려움을 해소
  - CloudWatch가 EventBridge의 작업을 수행하도록 지시

- **활용**
  - 환경에 응답, 기능 활성화, 작업 시작, 데이터 정보 캡처를 위해 메시지 전송
  - 특정 지표를 조사하는 경보와 함께 CPU 사용률 지표 데이터를 CloudWatch로 보내는 EC2 인스턴스와 통합

### EventBridge와 SNS 통합

- **알림 시스템**
  - EventBridge가 서드 파티 모니터링 도구와 통합
  - Simple Notification Service (SNS)를 통해 알림 이메일 전송
  - 예: '애플리케이션 팀의 상황이 경보 상태입니다', 'CPU 사용률이 너무 높아요'
![](Pasted%20image%2020240610092118.png)

## 결론

- **CloudWatch 경보**는 인프라 변경에 대한 자동화된 액션을 수행하는 데 유용
- **EventBridge**와 통합하여 다양한 작업을 자동화하고 알림을 전송
- **실제 사례**를 통해 경보 설정과 트리거 작업의 중요성 및 활용 방법 이해

# 로드 밸런싱

### 로드 밸런싱 개요

- **로드 밸런싱의 역할**
    
    - 여러 대상 간의 트래픽 분산
    - 대상은 EC2 인스턴스, Lambda 등 다양한 서비스 가능
- **고가용성**
    
    - Elastic Load Balancer (ELB)는 리전 범위 서비스
    - 인스턴스 장애 시 트래픽 전송 중단 및 상태 확인
    - HTTP 상태 확인을 통해 인스턴스 상태 감시

### OSI 계층 및 로드 밸런서 유형

- **OSI 모델**
    
    - **계층 1**: 물리 계층
    - **계층 2**: 데이터 계층
    - **계층 3**: 네트워크 계층
    - **계층 4**: 전송 계층
    - **계층 5**: 세션 계층
    - **계층 6**: 프레젠테이션 계층
    - **계층 7**: 애플리케이션 계층
- **로드 밸런서 유형**
    
    - **Gateway Load Balancer**: OSI 계층 3에서 동작, IP 포트 및 프로토콜 기반
    - **Application Load Balancer (ALB)**: OSI 계층 7에서 동작, 애플리케이션 컨텐츠 기반
    - **Network Load Balancer (NLB)**: OSI 계층 4에서 동작, TCP 및 UDP 지원

### 로드 밸런서 사용 패턴

- **Application Load Balancer (ALB)** 7
    
    - URL 기반 트래픽 분산
    - 예: `a.com/members` 요청은 '회원' 서비스로, `a.com/orders` 요청은 '주문' 서비스로 연결
- **Network Load Balancer (NLB)** 4
    
    - 포트 기반 트래픽 분산
    - 예: `a.com`의 8080 포트는 '회원' 서비스로, 9090 포트는 '주문' 서비스로 연결
- **Gateway Load Balancer (GWLB)** 3
    
    - 보안 장비와 연동
    - 트래픽이 인터넷 게이트웨이, GWLB 엔드포인트, 보안 장비를 통해 보안 검사 후 애플리케이션에 전달
![](Pasted%20image%2020240610093639.png)
![](Pasted%20image%2020240610093710.png)

### 로드 밸런서의 기능 및 오버헤드

![](Pasted%20image%2020240610093729.png)
- **Application Load Balancer (ALB)**
    
    - 애플리케이션 인식, 리디렉션, 고정된 응답 작업 등 다양한 기능 제공
    - OSI 계층 7에서 동작하여 애플리케이션 컨텐츠 기반 결정
- **Gateway Load Balancer (GWLB)**
    
    - OSI 계층 3에서 동작, 오버헤드 적음
    - 초당 더 많은 연결 및 처리량 제공
    - 보안 장비와의 연동에 유용

### 적절한 로드 밸런서 선택

- **로드 밸런서 종류에 따른 선택 기준**
    - **ALB**: 애플리케이션 레벨 트래픽 분산 필요 시
    - **NLB**: 포트 및 프로토콜 기반 트래픽 분산 필요 시
    - **GWLB**: 보안 장비와의 연동 필요 시

# 자동 크기 조정

### 개요

자동 크기 조정은 수요에 맞춰 리소스를 동적으로 추가하거나 제거함으로써 인프라의 비용 효율성과 고가용성을 높이는 전략입니다. 이는 AWS와 같은 클라우드 환경에서 특히 중요하며, AWS Auto Scaling을 통해 쉽게 구현할 수 있습니다.

### 인프라 확장 및 축소

- **기존 인프라(온프레미스)**
    
    - 하드웨어 조달, 설치, 배치가 필요
    - 용량을 고정적으로 추가함에 따라 계단형 증가 그래프 형태를 보임
    - 과잉 프로비저닝 시 비용 및 자원 낭비
    - 부족할 경우 서비스 가용성 문제 발생
- **AWS Auto Scaling을 통한 인프라**
    
    - 필요할 때 리소스를 추가하고, 불필요할 때 제거하는 탄력적 확장
    - 수요에 따라 인프라가 동적으로 변동
    - 비용 효율성 및 서비스 가용성 확보

### AWS Auto Scaling

![](Pasted%20image%2020240610101048.png)
- **작동 방식**
    - 필요할 때 인프라를 추가하고, 필요하지 않을 때 제거
    - 확장(Scale-Out) 및 축소(Scale-In)를 통해 인프라를 동적으로 조정
    - 시작 템플릿 및 Auto Scaling 그룹 설정을 통해 인프라 구성
- **시작 템플릿**
    - ![](Pasted%20image%2020240610101302.png)
    - 인스턴스 유형, EBS 볼륨, AMI, 사용자 데이터, 탄력적 네트워크 인터페이스 정의
    - 인스턴스를 시작하는 방법을 AWS에게 설명(설계서)
- **Auto Scaling 그룹**
    - ![](Pasted%20image%2020240610101313.png)
    - 최소 및 최대 인스턴스 수, 원하는 용량 정의
    - VPC와 서브넷 선택하여 인스턴스 배포
    - CloudWatch 경보를 통해 확장 및 축소 시점 결정

### CloudWatch 경보와 Auto Scaling 정책

- **CloudWatch 경보**
    - CPU 사용률, 읽기/쓰기 처리량 등 다양한 지표를 기준으로 경보 설정
    - 경보에 따라 Auto Scaling 정책 실행
- **Auto Scaling 정책**
    - CPU 사용률 75% 이상 시 인스턴스 추가
    - CPU 사용률 50% 이하 시 인스턴스 제거

### Auto Scaling 방법

![](Pasted%20image%2020240610101412.png)
- **예약된 방법**
    - 예측 가능한 워크로드에 대한 사전 설정
    - 예: 트래픽 증가 예상 시간에 미리 확장
- **동적 조정 방법**
    - 실시간 지표를 기반으로 자동 조정
    - 예: CPU 사용률이 특정 수준을 유지하도록 인스턴스 추가/제거
- **예측 가능 방법**
    - 기계 학습을 통한 패턴 인식 및 조정
    - 일정한 워크로드 패턴에 맞춰 자동 조정

### 비용 최적화

![](Pasted%20image%2020240610101430.png)
- **EC2 가격 옵션**
    - 온디맨드 인스턴스, 스팟 인스턴스, Savings Plan 혼합 사용
    - 비용 절감을 위해 다양한 인스턴스 유형 활용

### 로드 밸런싱과 Auto Scaling

- **로드 밸런서 역할**
    - 트래픽을 EC2 인스턴스로 분배
    - 선택 사항이지만 Auto Scaling과 잘 결합됨
- **Auto Scaling 그룹**
    - 수요와 용량에 따라 인스턴스 플릿 조정
    - 로드 밸런서 없이도 사용 가능

# 지식 확인

1. Application Load Balancer의 유효한 대상에 해당하는 옵션은 무엇입니까?

- **Amazon EC2 인스턴스**
- 가용 영역
- Amazon S3
- 가상 프라이빗 네트워크(VPN) 연결

2. 최소 2개의 인스턴스에서 실행되며 트래픽 패턴을 예측할 수 없는 애플리케이션을 사용하는 애플리케이션 지원 팀이 CPU 사용률을 75% 정도로 유지하려고 합니다. 이 팀은 어떤 Amazon EC2 AutoScaling 전략을 선택해야 합니까?

- 예약됨
- **동적**
- 예측
- 수동

3. 계정 리소스 및 지원되는 서드 파티 관리 서비스의 데이터를 기준으로 작업을 호출할 수 있는 서비스는 무엇입니까?

- Amazon CloudWatch Logs
- **Amazon EventBridge**
- AWS CloudTrail
- Amazon EC2 Auto Scaling

4. Amazon CloudWatch에서 유효한 경보 상태에 해당하는 옵션은 무엇입니까? (2개 선택) 

- READY
- ALERT
- **ALARM**
- **INSUFFICIENT_DATA**
- FAILED

1. AWS CloudTrail 데이터의 사용 사례에 해당하는 옵션은 무엇입니까? (2개 선택) 

- AWS 리소스의 실시간 관찰 기능을 제공
- **계정 사용 기록으로 로그 데이터를 저장**
- 특정 서비스 또는 애플리케이션에 대한 로깅 이벤트
- **루트 로그인 실패를 캡처**
- CPU 사용률을 측정하는 지표 데이터 수집

# 실습 4: Amazon VPC에서 고가용성 구성

![](Pasted%20image%2020240610102228.png)

## 과제 1: 기존 실습 환경 검사

AWS CloudFormation을 통해 다음 리소스가 프로비저닝되었습니다.

- Amazon Virtual Private Cloud(Amazon VPC)
- 2개의 가용 영역에 있는 퍼블릭 및 프라이빗 서브넷
- 퍼블릭 서브넷에 연결된 인터넷 게이트웨이(다이어그램에 표시되지 않음)
- 퍼블릭 서브넷 중 하나에 있는 NAT 게이트웨이
- 들어오는 애플리케이션 트래픽을 수신하고 전달하기 위해 2개의 퍼블릭 서브넷에 배포된 Application Load Balancer
- 프라이빗 서브넷 중 하나에 포함되어 있으며 기본적인 재고 추적 애플리케이션을 실행하는 EC2 인스턴스
- 재고 데이터를 저장하고 프라이빗 서브넷 중 하나에 있는 단일 DB 인스턴스가 포함된 Aurora DB 클러스터

![](Pasted%20image%2020240610102318.png)

### 과제 1.1: 네트워크 인프라 검사

#### 1. VPC 확인

- **VPC 검색 및 선택:** AWS Management Console 상단 검색 창에서 VPC 검색.
- **Lab VPC 확인:** 'Your VPCs'에서 Lab VPC 확인.

#### 2. 서브넷 확인

- **서브넷 선택:** 왼쪽 탐색 창에서 'Subnets' 선택.
- **Public Subnet 1 확인:**
    - **VPC:** Lab VPC에 속함.
    - **IPv4 CIDR:** 10.0.0.0/24 (256개의 IP 중 5개는 예약됨).
    - **가용 영역:** 'a'로 끝나는 가용 영역.
    - **Route Table 탭:**
        - **첫 번째 항목:** VPC 내 트래픽은 로컬 라우팅.
        - **두 번째 항목:** 인터넷 트래픽은 인터넷 게이트웨이로 라우팅.
    - **Network ACL 탭:** 모든 트래픽의 전송 및 수신 허용.

#### 3. 인터넷 게이트웨이 확인

- **Internet gateways 선택:** Lab IG가 Lab VPC에 연결됨.

#### 4. 보안 그룹 확인

- **Security groups 선택:**

##### 4.1. Inventory-ALB 보안 그룹

- **Inbound rules:** 어디서나 오는 인바운드 웹 트래픽(포트 80) 허용.
- **Outbound rules:** 모든 아웃바운드 트래픽 허용 (필요에 따라 수정 가능).

##### 4.2. Inventory-App 보안 그룹

- **Inbound rules:** Inventory-ALB 보안 그룹에서 오는 인바운드 웹 트래픽(포트 80)만 허용.
- **Outbound rules:** 모든 아웃바운드 트래픽 허용 (필요에 따라 수정 가능).

##### 4.3. Inventory-DB 보안 그룹

- **Inbound rules:** Inventory-App 보안 그룹에서 오는 인바운드 MYSQL/Aurora 트래픽(포트 3306)만 허용.
- **Outbound rules:** 모든 아웃바운드 트래픽 허용 (필요에 따라 수정 가능).

### 과제 1.2: EC2 인스턴스 검사

## 과제 2: 시작 템플릿 생성

EC2 콘솔 열기 -> 시작 템플릿 생성 -> 템플릿 정보 입력 -> AMI 선택 -> 인스턴스 유형 선택 -> 보안그룹 선택 -> 

#### 고급 세부 정보 입력

- **Advanced details 섹션 확장:**
    - **IAM instance profile:** `Inventory-App-Role` 선택.
    - **Metadata version:** `V2 only (token required)` 선택.
    - **User data 섹션:** 과제 1.2에서 저장한 사용자 데이터 붙여 넣기.

## 과제 3: Auto Scaling 그룹 생성

이 과제에서는 프라이빗 서브넷에 EC2 인스턴스를 배포하는 Auto Scaling 그룹을 생성합니다. 프라이빗 서브넷의 인스턴스는 인터넷에서 액세스할 수 없기 때문에 애플리케이션을 배포할 때는 이것이 보안 모범 사례입니다. 대신 사용자가 Application Load Balancer에 요청을 보내면 다음 다이어그램과 같이 해당 요청이 프라이빗 서브넷에 있는 EC2 인스턴스에 전달됩니다.

![](Pasted%20image%2020240610111558.png)

## 과제 4: 애플리케이션 테스트

![](Pasted%20image%2020240610115928.png)

## 과제 5: 애플리케이션 티어의 고가용성 테스트

## 과제 6: 데이터베이스 티어의 고가용성 구성

## 과제 7: NAT 게이트웨이가 고가용성을 제공하도록 설정

![](Pasted%20image%2020240610120319.png)

2개의 가용 영역에 걸친 프라이빗 서브넷에 Inventory-App 서버가 배포되어 있습니다. 인터넷에 액세스해야 하는 경우(예: 데이터 다운로드) 요청은 퍼블릭 서브넷에 있는 NAT 게이트웨이를 통해 리디렉션되어야 합니다. 현재 아키텍처에는 Public Subnet 1에 NAT 게이트웨이 하나만 있고, 모든 Inventory-App 서버가 이 NAT 게이트웨이를 사용하여 인터넷에 연결합니다. 즉, 가용 영역 1에서 장애가 발생하면 어느 애플리케이션 서버도 인터넷과 통신할 수 없습니다. 가용 영역 2에 두 번째 NAT 게이트웨이를 추가하면 가용 영역 1에 장애가 발생하더라도 프라이빗 서브넷의 리소스가 인터넷에 연결할 수 있습니다.

## 과제 8: Aurora 데이터베이스 장애 조치 적용

